<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Ç—Ä–æ–ª—å –ü–æ—Å—Ç–∞–≤–æ–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: var(--tg-theme-bg-color, #f5f5f5); color: var(--tg-theme-text-color, #000); }
        .card { background-color: var(--tg-theme-secondary-bg-color, #fff); }
        /* –ê–Ω–∏–º–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        .modal-enter { opacity: 0; transform: scale(0.9); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s; }
        .modal-exit { opacity: 0; transform: scale(0.9); transition: all 0.2s; }
    </style>
</head>
<body class="p-4 pb-20 select-none">

    <h1 class="text-xl font-bold mb-4">üì¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏</h1>

    <div class="mb-6 bg-white p-3 rounded-lg shadow-sm">
        <textarea id="bulkInput" rows="1" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫..." 
                  class="w-full p-2 border border-gray-200 rounded text-sm text-black focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
        <button onclick="parseAndAdd()" class="mt-2 w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow hover:bg-blue-700 transition flex justify-center items-center gap-2">
            <span>‚ö°Ô∏è –î–æ–±–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</span>
        </button>
    </div>

    <div class="flex gap-2 mb-4 overflow-x-auto pb-2 scrollbar-hide">
        <button onclick="filterShow('all')" class="px-4 py-1.5 bg-gray-200 rounded-lg text-sm font-medium whitespace-nowrap">–í—Å–µ</button>
        <button onclick="filterShow('new')" class="px-4 py-1.5 bg-red-100 text-red-700 rounded-lg text-sm font-medium whitespace-nowrap">üî¥ –ù–æ–≤—ã–µ</button>
        <button onclick="filterShow('ordered')" class="px-4 py-1.5 bg-yellow-100 text-yellow-700 rounded-lg text-sm font-medium whitespace-nowrap">üü° –í –ø—É—Ç–∏</button>
    </div>

    <div id="ordersList" class="space-y-3"></div>

    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-10/12 max-w-sm shadow-2xl transform transition-all">
            <h3 id="modalTitle" class="text-lg font-bold mb-2">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
            <p id="modalText" class="text-gray-600 mb-6">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-3 bg-gray-200 rounded-lg font-medium">–ù–µ—Ç</button>
                <button id="modalConfirmBtn" class="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold">–î–∞</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- –ë–ê–ó–ê –î–ê–ù–ù–´–• ---
        let orders = JSON.parse(localStorage.getItem('supply_orders_v3')) || [];
        let currentFilter = 'all';

        function saveOrders() {
            localStorage.setItem('supply_orders_v3', JSON.stringify(orders));
            renderOrders(currentFilter);
        }

        // --- –ü–ê–†–°–ï–† ---
        function parseAndAdd() {
            const text = document.getElementById('bulkInput').value;
            if (!text.trim()) return;

            const rawBlocks = text.split('üì¶');
            let addedCount = 0;

            rawBlocks.forEach(block => {
                if (!block.trim()) return;
                const lines = block.split('\n').map(l => l.trim()).filter(l => l);
                let itemName = lines[0]; 
                let quantity = "1 —à—Ç"; 
                const buyLine = lines.find(l => l.toUpperCase().includes('–ö–£–ü–ò–¢–¨') || l.includes('üõí'));
                if (buyLine) quantity = buyLine.replace(/.*–ö–£–ü–ò–¢–¨:?/i, '').replace('üõí', '').trim();

                if (itemName.length < 2) return;

                orders.unshift({
                    id: Date.now() + Math.random(),
                    text: itemName,
                    qty: quantity, 
                    status: 'new',
                    // –í–∞–∂–Ω–æ: —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è 7 –¥–Ω–µ–π
                    createdAt: Date.now(), 
                    displayDate: new Date().toLocaleDateString()
                });
                addedCount++;
            });

            if (addedCount > 0) {
                document.getElementById('bulkInput').value = '';
                saveOrders();
                tg.HapticFeedback.notificationOccurred('success');
            }
        }

        // --- –õ–û–ì–ò–ö–ê –î–ï–ô–°–¢–í–ò–ô ---

        // 1. –£–¥–∞–ª–µ–Ω–∏–µ (–ö–æ—Ä–∑–∏–Ω–∞)
        function deleteItem(id) {
            showModal('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?', '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.', () => {
                orders = orders.filter(o => o.id !== id);
                saveOrders();
            });
        }

        // 2. –°–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞
        function nextStatus(id) {
            const order = orders.find(o => o.id === id);
            if (!order) return;

            if (order.status === 'new') {
                order.status = 'ordered';
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É, —á—Ç–æ–±—ã —Å—á–∏—Ç–∞—Ç—å 7 –¥–Ω–µ–π –∏–º–µ–Ω–Ω–æ —Å –º–æ–º–µ–Ω—Ç–∞ –ó–ê–ö–ê–ó–ê
                order.createdAt = Date.now(); 
                order.displayDate = new Date().toLocaleDateString();
                saveOrders();
            } else if (order.status === 'ordered') {
                showModal('–¢–æ–≤–∞—Ä –ø–æ–ª—É—á–µ–Ω?', '–ó–∞–∫–∞–∑ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω –∏–∑ —Å–ø–∏—Å–∫–∞ –æ–∂–∏–¥–∞–µ–º—ã—Ö.', () => {
                    orders = orders.filter(o => o.id !== id); // –£–¥–∞–ª—è–µ–º, —Ç–∞–∫ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω
                    saveOrders();
                    tg.HapticFeedback.notificationOccurred('success');
                });
            }
        }

        // --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û (–ó–∞–º–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–º—É confirm) ---
        let currentConfirmAction = null;

        function showModal(title, text, onConfirm) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalText').innerText = text;
            currentConfirmAction = onConfirm;
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            currentConfirmAction = null;
        }

        document.getElementById('modalConfirmBtn').onclick = () => {
            if (currentConfirmAction) currentConfirmAction();
            closeModal();
        };

        // --- –û–¢–†–ò–°–û–í–ö–ê –ò –õ–û–ì–ò–ö–ê 7 –î–ù–ï–ô ---
        function renderOrders(filter) {
            const container = document.getElementById('ordersList');
            container.innerHTML = '';
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ, –ø–æ—Ç–æ–º –Ω–æ–≤—ã–µ
            const filteredOrders = orders.filter(o => filter === 'all' ? true : o.status === filter);

            if (filteredOrders.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 mt-10 text-sm">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>';
                return;
            }

            const NOW = Date.now();
            const SEVEN_DAYS_MS = 7 * 24 * 60 * 60 * 1000;
            // –î–ª—è —Ç–µ—Å—Ç–∞ –º–æ–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å 1 –º–∏–Ω—É—Ç—É: 60 * 1000
            
            filteredOrders.forEach(order => {
                let statusColor = '';
                let btnText = '';
                let btnColor = '';
                let alertHtml = '';

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É (—Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–∫–∞–∑–∞–Ω–Ω—ã—Ö)
                const isOverdue = (order.status === 'ordered' && (NOW - order.createdAt > SEVEN_DAYS_MS));

                if (order.status === 'new') {
                    statusColor = 'border-red-500 bg-white';
                    btnText = '–ó–∞–∫–∞–∑–∞—Ç—å';
                    btnColor = 'bg-blue-600';
                } else {
                    // Ordered
                    statusColor = 'border-yellow-400 bg-yellow-50';
                    btnText = '–ü—Ä–∏–Ω—è—Ç—å';
                    btnColor = 'bg-green-600';
                    
                    if (isOverdue) {
                        statusColor = 'border-red-600 bg-red-50'; // –ö—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω —Ç—Ä–µ–≤–æ–≥–∏
                        alertHtml = `<div class="text-red-600 text-xs font-bold mt-1">‚ö†Ô∏è –ó–ê–î–ï–†–ñ–ö–ê –ë–û–õ–ï–ï 7 –î–ù–ï–ô!</div>`;
                    }
                }
                
                let qtyBadge = `<span class="bg-gray-100 text-gray-800 text-xs font-bold px-2 py-1 rounded border border-gray-300 whitespace-nowrap">${order.qty}</span>`;

                const html = `
                <div class="card p-3 rounded-lg shadow-sm border-l-4 ${statusColor} mb-3 relative">
                    <button onclick="deleteItem(${order.id})" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>

                    <div class="flex justify-between items-start w-11/12">
                        <div class="font-medium text-base leading-tight pr-2">
                            ${order.text}
                            ${alertHtml}
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-end mt-3">
                        <div class="flex flex-col gap-1">
                            ${qtyBadge}
                            <span class="text-[10px] text-gray-400">–æ—Ç ${order.displayDate}</span>
                        </div>
                        <button onclick="nextStatus(${order.id})" 
                                class="${btnColor} text-white text-xs font-bold px-4 py-2 rounded-lg shadow active:scale-95 transition">
                            ${btnText}
                        </button>
                    </div>
                </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        renderOrders('all');
    </script>
</body>
</html>
