<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Ç—Ä–æ–ª—å –ü–æ—Å—Ç–∞–≤–æ–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: var(--tg-theme-bg-color, #f5f5f5); color: var(--tg-theme-text-color, #000); }
        .card { background-color: var(--tg-theme-secondary-bg-color, #fff); }
    </style>
</head>
<body class="p-4 pb-20">

    <h1 class="text-xl font-bold mb-4">üì¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏</h1>

    <div class="mb-6 bg-white p-3 rounded-lg shadow-sm">
        <label class="text-xs text-gray-500 mb-1 block">–í—Å—Ç–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ TWA:</label>
        <textarea id="bulkInput" rows="2" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–µ—Å—å —Ç–µ–∫—Å—Ç —Å üì¶ –∏ üõí..." 
                  class="w-full p-2 border border-gray-200 rounded text-sm text-black focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
        <button onclick="parseAndAdd()" class="mt-2 w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow hover:bg-blue-700 transition flex justify-center items-center gap-2">
            <span>‚ö°Ô∏è –†–∞–∑–æ–±—Ä–∞—Ç—å —Å–ø–∏—Å–æ–∫</span>
        </button>
    </div>

    <div class="flex gap-2 mb-4 overflow-x-auto pb-2 scrollbar-hide">
        <button onclick="filterShow('all')" class="px-4 py-1.5 bg-gray-200 rounded-lg text-sm font-medium whitespace-nowrap">–í—Å–µ</button>
        <button onclick="filterShow('new')" class="px-4 py-1.5 bg-red-100 text-red-700 rounded-lg text-sm font-medium whitespace-nowrap">üî¥ –ù–æ–≤—ã–µ</button>
        <button onclick="filterShow('ordered')" class="px-4 py-1.5 bg-yellow-100 text-yellow-700 rounded-lg text-sm font-medium whitespace-nowrap">üü° –ó–∞–∫–∞–∑–∞–Ω–æ</button>
    </div>

    <div id="ordersList" class="space-y-3"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- –ë–ê–ó–ê –î–ê–ù–ù–´–• ---
        let orders = JSON.parse(localStorage.getItem('supply_orders_v2')) || [];
        let currentFilter = 'all';

        function saveOrders() {
            localStorage.setItem('supply_orders_v2', JSON.stringify(orders));
            renderOrders(currentFilter);
        }

        // --- –ù–û–í–´–ô –£–ú–ù–´–ô –ü–ê–†–°–ï–† ---
        function parseAndAdd() {
            const text = document.getElementById('bulkInput').value;
            if (!text.trim()) return;

            // 1. –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–µ –ø–æ —Å—Ç—Ä–æ–∫–∞–º, –∞ –ø–æ –∑–Ω–∞—á–∫—É –∫–æ—Ä–æ–±–∫–∏ üì¶
            // –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å 3-4 —Å—Ç—Ä–æ–∫–∏ –≤ –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä
            const rawBlocks = text.split('üì¶');

            let addedCount = 0;

            rawBlocks.forEach(block => {
                if (!block.trim()) return;

                // –†–∞–∑–±–∏–≤–∞–µ–º –±–ª–æ–∫ –Ω–∞ —Å—Ç—Ä–æ–∫–∏
                const lines = block.split('\n').map(l => l.trim()).filter(l => l);
                
                // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–æ—Å–ª–µ üì¶ - —ç—Ç–æ –æ–±—ã—á–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ
                let itemName = lines[0]; 

                // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É, –≥–¥–µ –µ—Å—Ç—å —Å–ª–æ–≤–æ "–ö–£–ü–ò–¢–¨" –∏–ª–∏ –∑–Ω–∞—á–æ–∫ üõí
                let quantity = "1 —à—Ç"; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                const buyLine = lines.find(l => l.toUpperCase().includes('–ö–£–ü–ò–¢–¨') || l.includes('üõí'));

                if (buyLine) {
                    // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ —Å–ª–æ–≤–∞, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏ –µ–¥. –∏–∑–º–µ—Ä–µ–Ω–∏—è
                    // –ü—Ä–∏–º–µ—Ä: "üõí –ö–£–ü–ò–¢–¨: 3.0 —à—Ç" -> "3.0 —à—Ç"
                    quantity = buyLine.replace(/.*–ö–£–ü–ò–¢–¨:?/i, '').replace('üõí', '').trim();
                }

                // –ï—Å–ª–∏ –∏–º—è —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ (–≥–ª—é–∫), –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                if (itemName.length < 2) return;

                orders.unshift({
                    id: Date.now() + Math.random(),
                    text: itemName,
                    qty: quantity, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–¥–µ–ª—å–Ω–æ
                    status: 'new',
                    date: new Date().toLocaleTimeString().slice(0, 5)
                });
                addedCount++;
            });

            if (addedCount > 0) {
                document.getElementById('bulkInput').value = '';
                saveOrders();
                tg.HapticFeedback.notificationOccurred('success');
                alert(`–î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: ${addedCount}`);
            } else {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –µ—Å—Ç—å –ª–∏ –∑–Ω–∞—á–∫–∏ üì¶ –≤ —Ç–µ–∫—Å—Ç–µ.');
            }
        }

        // --- –õ–û–ì–ò–ö–ê ---
        function updateStatus(id) {
            const order = orders.find(o => o.id === id);
            if (!order) return;

            if (order.status === 'new') {
                order.status = 'ordered';
            } else if (order.status === 'ordered') {
                if (confirm(`–¢–æ–≤–∞—Ä "${order.text}" –ø—Ä–∏–µ—Ö–∞–ª? –£–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞?`)) {
                    orders = orders.filter(o => o.id !== id);
                }
            }
            saveOrders();
        }

        function filterShow(status) {
            currentFilter = status;
            renderOrders(status);
        }

        // --- –û–¢–†–ò–°–û–í–ö–ê ---
        function renderOrders(filter) {
            const container = document.getElementById('ordersList');
            container.innerHTML = '';

            const filteredOrders = orders.filter(o => filter === 'all' ? true : o.status === filter);

            if (filteredOrders.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 mt-10 text-sm">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>';
                return;
            }

            filteredOrders.forEach(order => {
                let statusColor = order.status === 'new' ? 'border-red-500 bg-white' : 'border-yellow-400 bg-yellow-50';
                let btnText = order.status === 'new' ? '–ó–∞–∫–∞–∑–∞—Ç—å' : '–ü—Ä–∏–Ω—è—Ç—å';
                let btnColor = order.status === 'new' ? 'bg-blue-600' : 'bg-green-600';
                
                // –ö—Ä–∞—Å–∏–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
                let qtyBadge = `<span class="bg-gray-100 text-gray-800 text-xs font-bold px-2 py-1 rounded border border-gray-300 whitespace-nowrap">${order.qty}</span>`;

                const html = `
                <div class="card p-3 rounded-lg shadow-sm border-l-4 ${statusColor} flex flex-col gap-2 mb-3">
                    <div class="flex justify-between items-start">
                        <div class="font-medium text-base leading-tight pr-2">
                            ${order.text}
                        </div>
                        ${qtyBadge}
                    </div>
                    
                    <div class="flex justify-between items-center mt-1">
                        <span class="text-xs text-gray-400">${order.date}</span>
                        <button onclick="updateStatus(${order.id})" 
                                class="${btnColor} text-white text-xs font-bold px-4 py-2 rounded-lg shadow active:scale-95 transition">
                            ${btnText}
                        </button>
                    </div>
                </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        renderOrders('all');
    </script>
</body>
</html>
